# Battle Line - カードゲーム

## 概要

**Battle Line**は、C++とSiv3Dゲームエンジンを使用して開発された戦略的カードゲームです。2人のプレイヤーが9つの戦線（フラグ）を巡って競い合い、先に5つのフラグを獲得するか、連続する3つのフラグを制圧したプレイヤーが勝利します。

ローカル対戦とPhotonを使ったオンラインマルチプレイの両方に対応しています。

## 主な機能

### ゲームモード
- **ローカルプレイ**: 1台のPCで2人が交互にプレイ
- **オンラインマルチプレイ**: Photon Realtimeを使用したリアルタイムオンライン対戦
  - ルームコードによるマッチング機能
  - デッキ・手札・カード配置の完全同期

### カードシステム
- **通常カード**: 6色 × 1-10の値 = 60枚のデッキ
- **特殊カード**: 10種類の戦術カード
  - **部隊カード（Troop Cards）**:
    - ワイルドカード（リーダー、8、盾）- 任意の色・値として使用可能
  - **気象戦術カード（Weather Tactics）**:
    - 霧カード - 役を無視し、合計値のみで勝敗判定
    - 泥カード - 通常3枚のところ4枚でフラグの勝敗を決める
  - **謀略戦術カード（Conspiracy Tactics）**:
    - 偵察カード - 山札から3枚引き、手札から2枚を山札に戻す
    - 配置展開カード - 自分のカードを別のフラグに移動または削除
    - 脱走カード - 相手のカードを1枚削除
    - 裏切りカード - 相手のカードを自分のフラグに移動

### 役（Formations）
各フラグで3枚のカードから以下の役が成立します：
1. **フォーオブアカインド（4 of a Kind）**: 同じ値が4枚（泥カード使用時）
2. **ストレートフラッシュ（Straight Flush）**: 同じ色で連続した値
3. **スリーオブアカインド（3 of a Kind）**: 同じ値が3枚
4. **フラッシュ（Flush）**: 同じ色が3枚
5. **ストレート（Straight）**: 連続した値（色は異なる）

### UI/UX機能
- **ドラッグ&ドロップ**: 直感的なカード操作
- **リサイズ可能なウィンドウ**: 4:3のアスペクト比を維持
- **視覚的フィードバック**:
  - ホバー時のハイライト表示
  - 配置可能スロットの明示
  - ターン表示・指示テキスト

## 技術スタック

- **言語**: C++17
- **ゲームエンジン**: [Siv3D](https://siv3d.github.io/)
- **ネットワーク**: Photon Realtime SDK
- **ビルドシステム**: Visual Studio 2022

## プロジェクト構成

```
BattleLine_Siv3D/
├── include/
│   └── core/
│       ├── Card.h              # 通常カード
│       ├── SpecialCard.h       # 特殊カード
│       ├── Deck.h              # デッキ管理
│       ├── SpecialDeck.h       # 特殊カードデッキ
│       ├── Player.h            # プレイヤー管理
│       ├── GameState.h         # ゲーム状態管理
│       ├── Flag.h              # フラグ（戦線）
│       ├── Slot.h              # カード配置スロット
│       ├── WeatherSlot.h       # 気象カード用スロット
│       ├── ConspiracySlot.h    # 謀略カード用スロット
│       ├── DragManager.h       # ドラッグ操作管理
│       └── NetworkEvents.h     # ネットワークイベント定義
├── src/
│   ├── Main.cpp                # メインループ、UI、ネットワーク処理
│   ├── Multiplayer_Photon.cpp  # Photon統合
│   └── core/
│       ├── Card.cpp
│       ├── SpecialCard.cpp
│       ├── Player.cpp
│       ├── GameState.cpp
│       ├── GameStateSpecialCardHandlers.cpp  # 特殊カード処理
│       └── ...
├── App/
│   └── config.toml             # 設定ファイル（Photon App IDなど）
└── README.md
```

## セットアップ方法

### 必要環境
- Windows 10/11
- Visual Studio 2022
- [Siv3D](https://siv3d.github.io/) (OpenSiv3D 0.6.x)
- Photonアカウント（オンラインプレイを使用する場合）

### インストール手順

1. **リポジトリのクローン**:
   ```bash
   git clone https://github.com/bkeba01/BattleLine_Siv3D.git
   cd BattleLine_Siv3D
   ```

2. **Siv3Dのセットアップ**:
   - [公式ガイド](https://siv3d.github.io/ja-jp/download/windows/)に従ってSiv3Dをインストール

3. **Photonの設定**（オンラインプレイを使用する場合）:
   1. [Photonダッシュボード](https://dashboard.photonengine.com/)でアカウントを作成
   2. 新しいPhoton Realtimeアプリを作成
   3. `PHOTON_APP_ID.SECRET`ファイルを作成し、以下の内容を記述:
      ```cpp
      #define PHOTON_APP_ID "your-photon-app-id-here"
      ```
   4. または、`App/config.toml`に設定を記述:
      ```toml
      [photon]
      app_id = "your-photon-app-id-here"
      app_version = "1.0"
      ```

4. **プロジェクトのビルド**:
   - Visual Studio 2022で`.sln`ファイルを開く
   - `Release`または`Debug`構成でビルド

5. **実行**:
   - `App/BattleLine.exe`を起動

## 遊び方

### 基本ルール

1. **ゲーム開始**: 各プレイヤーは7枚の手札からスタート
2. **ターン進行**:
   - 手札から1枚選び、9つのフラグのいずれかに配置
   - 山札（通常デッキまたは特殊デッキ）から1枚引く
3. **フラグの獲得**:
   - 各フラグで3枚のカードが揃うと勝敗判定
   - より強い役を作ったプレイヤーがフラグを獲得
4. **勝利条件**:
   - 9つのフラグのうち5つを獲得
   - または連続する3つのフラグを獲得

### 特殊カードの使い方

- **部隊カード**: 通常カードと同様にフラグに配置
- **気象カード**: フラグの下の専用スロットに配置（そのフラグのルールを変更）
- **謀略カード**:
  - 偵察カード: 特殊デッキの横の専用スロットに配置後、UIに従って操作
  - その他: 配置後、画面の指示に従って対象を選択

### オンライン対戦

1. メニューから「オンラインマルチプレイ」を選択
2. 「サーバーに接続」をクリック
3. **ルーム作成**: 「ルーム作成」で4桁のルームコードが生成される
4. **ルーム参加**: 「ルームに参加」で相手のルームコードを入力
5. 2人揃うと自動的にゲームが開始

## 技術的な特徴

### アーキテクチャ
- **MVC的な設計**: GameStateがモデル、Mainがコントローラー兼ビュー
- **ポリモーフィズム**: CardBaseを基底クラスとしたCard/SpecialCardの継承
- **スマートポインタの活用**: メモリ管理にstd::shared_ptrを使用

### ネットワーク同期
- **決定論的ゲームプレイ**:
  - ホストがゲームシード（乱数種）を送信
  - 両プレイヤーが同じシードでデッキをシャッフル
  - カード配置などのアクションのみをネットワーク送信
- **イベント駆動アーキテクチャ**:
  - カスタムイベント（GAME_INIT, CARD_PLACED, DECK_CHOICE等）
  - 非同期処理に対応

### レスポンシブUI
- ウィンドウリサイズに対応した動的レイアウト
- アスペクト比維持（4:3固定）
- 相対座標によるオブジェクト配置

## 開発の経緯

このプロジェクトは、以下の技術を学習・実践するために開発されました：
- C++のオブジェクト指向プログラミング
- ゲームループとイベント駆動設計
- リアルタイムネットワークゲームの同期
- Siv3Dを使ったゲーム開発

### 実装の進捗（gitログより）
1. ドラッグ&ドロップ機能の実装
2. プレイヤー交代システム、デッキからのカード補充
3. フラグの勝敗判定システム
4. 特殊カード（偵察、脱走、裏切りカード等）の実装
5. Photonによるマルチプレイヤー対応
6. カード配置・デッキ選択の完全同期

## 既知の問題と注意事項
まだまだ未完成なため不具合がいくつかあります。ご了承ください。
### 開発中の機能
- 偵察カード（ReconCard）の処理後、一部のケースでターンが正しく進まない場合がある
- デバッグ用のPrint文が多数残っている（Main.cpp:336-390等）

### 今後の改善予定
- エラーハンドリングの強化
- デバッグコードのクリーンアップ
- UI/UXの洗練
- チュートリアルとカードの説明

## ライセンス

このプロジェクトは学習・ポートフォリオ目的で作成されています。

## 使用しているライブラリ・SDK

- [OpenSiv3D](https://siv3d.github.io/) - MITライセンス
- [Photon Realtime](https://www.photonengine.com/realtime) - Exit Games社のSDK

## クレジット

開発者: bkeba01

---

**注意**: このゲームは「Battle Line」というボードゲームをデジタル化したものです。オリジナルゲームの権利は各権利者に帰属します。
